<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sistema de Sincroniza√ß√£o Kommo</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background-color: #f5f5f5;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      .header {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .header h1 {
        color: #2c3e50;
        margin-bottom: 10px;
      }

      .status-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }

      .status-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
      }

      .status-item {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
      }

      .status-number {
        font-size: 2em;
        font-weight: bold;
        color: #3498db;
      }

      .status-label {
        color: #666;
        margin-top: 5px;
      }

      .actions {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
        margin-bottom: 20px;
      }

      .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.2s;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: #3498db;
        color: white;
      }

      .btn-primary:hover {
        background: #2980b9;
      }

      .btn-success {
        background: #27ae60;
        color: white;
      }

      .btn-success:hover {
        background: #229954;
      }

      .btn-warning {
        background: #f39c12;
        color: white;
      }

      .btn-warning:hover {
        background: #e67e22;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-danger {
        background: #e74c3c;
        color: white;
      }

      .btn-danger:hover {
        background: #c0392b;
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .logs-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .log-item {
        padding: 15px;
        border-left: 4px solid #ddd;
        margin-bottom: 10px;
        background: #f8f9fa;
      }

      .log-item.success {
        border-left-color: #27ae60;
      }

      .log-item.failed {
        border-left-color: #e74c3c;
      }

      .log-item.started {
        border-left-color: #f39c12;
      }

      .log-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }

      .log-type {
        font-weight: bold;
        text-transform: uppercase;
        font-size: 12px;
      }

      .log-time {
        color: #666;
        font-size: 12px;
      }

      .log-message {
        color: #555;
      }

      .loading {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .loading.show {
        display: block;
      }

      .alert {
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
      }

      .modal-content {
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 500px;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: black;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .webhook-info {
        background: #e8f4f8;
        padding: 15px;
        border-radius: 6px;
        margin-top: 20px;
      }

      .webhook-url {
        font-family: monospace;
        background: #f1f1f1;
        padding: 8px;
        border-radius: 4px;
        word-break: break-all;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>Sistema de Sincroniza√ß√£o Kommo</h1>
        <p>
          Gerencie a sincroniza√ß√£o de configura√ß√µes entre suas 120 contas Kommo
        </p>
      </div>

      <div id="alerts"></div>

      <div class="status-card">
        <h2>Status do Sistema</h2>
        <div class="status-grid" id="statusGrid">
          <div class="status-item">
            <div class="status-number" id="totalAccounts">-</div>
            <div class="status-label">Total de Contas</div>
          </div>
          <div class="status-item">
            <div class="status-number" id="masterAccounts">-</div>
            <div class="status-label">Conta Mestre</div>
          </div>
          <div class="status-item">
            <div class="status-number" id="slaveAccounts">-</div>
            <div class="status-label">Contas Escravas</div>
          </div>
          <div class="status-item">
            <div class="status-number" id="lastSyncStatus">-</div>
            <div class="status-label">√öltima Sincroniza√ß√£o</div>
          </div>
        </div>

        <div class="actions">
          <button
            class="btn btn-primary"
            onclick="triggerSync('full')"
            id="syncFullBtn"
          >
            Sincroniza√ß√£o Completa
          </button>
          <button
            class="btn btn-success"
            onclick="triggerSync('pipelines')"
            id="syncPipelinesBtn"
          >
            Sincronizar Funis
          </button>
          <button
            class="btn btn-warning"
            onclick="triggerSync('custom_fields')"
            id="syncFieldsBtn"
          >
            Sincronizar Campos
          </button>
          <button
            class="btn btn-success"
            onclick="triggerSync('required_statuses')"
            id="syncRequiredStatusesBtn"
            title="Sincronizar configura√ß√µes de campos obrigat√≥rios por pipeline/est√°gio"
          >
            üéØ Required Statuses
          </button>
          <button class="btn btn-primary" onclick="openAddAccountModal()">
            Adicionar Conta
          </button>
          <button class="btn btn-primary" onclick="refreshStatus()">
            Atualizar Status
          </button>
          <button class="btn btn-secondary" onclick="testConfig()">
            Testar Configura√ß√µes
          </button>
          <button class="btn btn-warning" onclick="testAllAccounts()">
            Testar Todas as Contas
          </button>
          <button class="btn btn-danger" onclick="clearAllAccounts()">
            Limpar Todas as Contas
          </button>
        </div>

        <div class="webhook-info">
          <h3>Webhook para Salesbot</h3>
          <p>
            Configure seu Salesbot para enviar um webhook para esta URL para
            acionar sincroniza√ß√µes autom√°ticas:
          </p>
          <div class="webhook-url" id="webhookUrl">Carregando...</div>
          <p>
            <small
              >O webhook deve ser enviado como POST com dados JSON do
              lead.</small
            >
          </p>
        </div>
      </div>

      <div class="loading" id="loading">
        <p>Processando sincroniza√ß√£o...</p>
      </div>

      <div class="logs-section">
        <h2>Hist√≥rico de Sincroniza√ß√µes</h2>
        <div id="logsContainer">
          <p>Carregando logs...</p>
        </div>
      </div>
    </div>

    <!-- Modal para adicionar conta -->
    <div id="addAccountModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeAddAccountModal()">&times;</span>
        <h2>Adicionar Conta Kommo</h2>
        <form id="addAccountForm">
          <div class="form-group">
            <label for="subdomain">Subdom√≠nio:</label>
            <input
              type="text"
              id="subdomain"
              name="subdomain"
              placeholder="exemplo"
              required
            />
            <small>Apenas o subdom√≠nio (sem .kommo.com)</small>
          </div>
          <div class="form-group">
            <label for="refreshToken">Refresh Token:</label>
            <input
              type="text"
              id="refreshToken"
              name="refresh_token"
              required
            />
            <small>Token de atualiza√ß√£o da conta Kommo</small>
          </div>
          <div class="form-group">
            <label for="isMaster">Tipo de Conta:</label>
            <select id="isMaster" name="is_master">
              <option value="false">Conta Escrava</option>
              <option value="true">Conta Mestre</option>
            </select>
          </div>
          <div class="form-group">
            <small style="color: #666; font-style: italic">
              üöÄ Sistema ultra-simplificado: access_tokens s√£o gerados
              automaticamente sob demanda<br />
              üîí M√°xima seguran√ßa: apenas subdom√≠nio e refresh_token s√£o
              armazenados<br />
              ‚ö° Sem configura√ß√µes extras: n√£o precisa de client_id nem
              client_secret
            </small>
          </div>
          <div class="actions">
            <button type="submit" class="btn btn-primary">
              Adicionar Conta
            </button>
            <button type="button" class="btn" onclick="closeAddAccountModal()">
              Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // Configura√ß√£o da API
      const API_BASE = "/api/sync";

      // Teste de conectividade
      async function testConnection() {
        try {
          console.log("Testando conex√£o com:", API_BASE);
          const response = await fetch(`${API_BASE}/status`);
          console.log(
            "Resposta do servidor:",
            response.status,
            response.statusText
          );

          if (!response.ok) {
            const errorText = await response.text();
            console.error(`Erro HTTP ${response.status}:`, errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          // Verificar se a resposta √© JSON v√°lido
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            const responseText = await response.text();
            console.error(
              "Resposta n√£o √© JSON:",
              responseText.substring(0, 200)
            );
            throw new Error(
              "Servidor retornou HTML em vez de JSON. Verifique se as rotas da API est√£o funcionando."
            );
          }

          const data = await response.json();
          console.log("Dados recebidos:", data);
          return data;
        } catch (error) {
          console.error("Erro de conex√£o:", error);
          showAlert(
            `Erro de conex√£o: ${error.message}. Verifique se o servidor Flask est√° rodando em http://localhost:5000`,
            "error"
          );
          throw error;
        }
      }

      // Inicializa√ß√£o
      document.addEventListener("DOMContentLoaded", function () {
        // Testar conex√£o primeiro
        testConnection()
          .then(() => {
            refreshStatus();
            loadLogs();
            updateWebhookUrl();
          })
          .catch(() => {
            console.log("Falha na conex√£o inicial");
            document.getElementById("logsContainer").innerHTML =
              '<p style="color: red;">‚ùå Erro: Servidor Flask n√£o est√° acess√≠vel. Execute: <code>python src/main.py</code></p>';
          });
      });

      // Atualizar URL do webhook
      function updateWebhookUrl() {
        const webhookUrl = `${window.location.origin}/api/sync/webhook`;
        document.getElementById("webhookUrl").textContent = webhookUrl;
      }

      // Mostrar alerta
      function showAlert(message, type = "success") {
        const alertsContainer = document.getElementById("alerts");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertsContainer.appendChild(alert);

        setTimeout(() => {
          alert.remove();
        }, 5000);
      }

      // Atualizar status do sistema
      async function refreshStatus() {
        try {
          console.log("Buscando status em:", `${API_BASE}/status`);
          const response = await fetch(`${API_BASE}/status`);

          if (!response.ok) {
            const errorText = await response.text();
            console.error(`Erro HTTP ${response.status}:`, errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          // Verificar se a resposta √© JSON v√°lido
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            const responseText = await response.text();
            console.error(
              "Resposta n√£o √© JSON:",
              responseText.substring(0, 200)
            );
            throw new Error(
              "API retornou HTML em vez de JSON. Verifique se a rota /api/sync/status existe."
            );
          }

          const data = await response.json();
          console.log("Status recebido:", data);

          if (data.success) {
            const status = data.status;
            document.getElementById("totalAccounts").textContent =
              status.accounts.total;
            document.getElementById("masterAccounts").textContent =
              status.accounts.master;
            document.getElementById("slaveAccounts").textContent =
              status.accounts.slaves;

            if (status.last_sync) {
              document.getElementById("lastSyncStatus").textContent =
                status.last_sync.status;
            } else {
              document.getElementById("lastSyncStatus").textContent = "Nenhuma";
            }
          } else {
            showAlert("Erro ao carregar status: " + data.error, "error");
          }
        } catch (error) {
          console.error("Erro no refreshStatus:", error);
          showAlert(
            "Erro de conex√£o no status. Verifique se o servidor est√° rodando.",
            "error"
          );
        }
      }

      // Acionar sincroniza√ß√£o
      async function triggerSync(syncType) {
        const buttons = [
          "syncFullBtn",
          "syncPipelinesBtn",
          "syncFieldsBtn",
          "syncRequiredStatusesBtn",
        ];
        buttons.forEach((id) => {
          const btn = document.getElementById(id);
          if (btn) btn.disabled = true;
        });

        document.getElementById("loading").classList.add("show");

        try {
          const response = await fetch(`${API_BASE}/trigger`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ sync_type: syncType }),
          });

          const data = await response.json();

          if (data.success) {
            let message = `Sincroniza√ß√£o ${syncType} conclu√≠da com sucesso!`;
            if (syncType === "required_statuses") {
              message = `üéØ Sincroniza√ß√£o de Required Statuses conclu√≠da com sucesso!`;
            }
            showAlert(message, "success");
            refreshStatus();
            loadLogs();
          } else {
            showAlert("Erro na sincroniza√ß√£o: " + data.error, "error");
          }
        } catch (error) {
          showAlert("Erro de conex√£o: " + error.message, "error");
        } finally {
          document.getElementById("loading").classList.remove("show");
          buttons.forEach((id) => {
            const btn = document.getElementById(id);
            if (btn) btn.disabled = false;
          });
        }
      }

      // Carregar logs
      async function loadLogs() {
        try {
          console.log("Buscando logs em:", `${API_BASE}/logs?per_page=10`);
          const response = await fetch(`${API_BASE}/logs?per_page=10`);

          if (!response.ok) {
            const errorText = await response.text();
            console.error(`Erro HTTP ${response.status}:`, errorText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }

          // Verificar se a resposta √© JSON v√°lido
          const contentType = response.headers.get("content-type");
          if (!contentType || !contentType.includes("application/json")) {
            const responseText = await response.text();
            console.error(
              "Resposta n√£o √© JSON:",
              responseText.substring(0, 200)
            );
            throw new Error(
              "API retornou HTML em vez de JSON. Verifique se a rota /api/sync/logs existe."
            );
          }

          const data = await response.json();
          console.log("Logs recebidos:", data);

          if (data.success) {
            const logsContainer = document.getElementById("logsContainer");
            logsContainer.innerHTML = "";

            if (data.logs.length === 0) {
              logsContainer.innerHTML = "<p>Nenhum log encontrado.</p>";
              return;
            }

            data.logs.forEach((log) => {
              const logItem = document.createElement("div");
              logItem.className = `log-item ${log.status}`;

              const startedAt = new Date(log.started_at).toLocaleString(
                "pt-BR"
              );
              const completedAt = log.completed_at
                ? new Date(log.completed_at).toLocaleString("pt-BR")
                : "Em andamento";

              logItem.innerHTML = `
                            <div class="log-header">
                                <span class="log-type">${log.sync_type} - ${
                log.status
              }</span>
                                <span class="log-time">${startedAt}</span>
                            </div>
                            <div class="log-message">${log.message}</div>
                            <div style="margin-top: 5px; font-size: 12px; color: #666;">
                                Processadas: ${
                                  log.accounts_processed || 0
                                } | Falhas: ${log.accounts_failed || 0}
                                ${
                                  log.completed_at
                                    ? ` | Conclu√≠da: ${completedAt}`
                                    : ""
                                }
                            </div>
                        `;

              logsContainer.appendChild(logItem);
            });
          } else {
            document.getElementById("logsContainer").innerHTML =
              "<p>Erro ao carregar logs: " + data.error + "</p>";
          }
        } catch (error) {
          console.error("Erro no loadLogs:", error);
          document.getElementById("logsContainer").innerHTML =
            '<p style="color: red;">‚ùå Erro de conex√£o ao carregar logs. Servidor pode estar offline.</p>';
        }
      }

      // Modal de adicionar conta
      function openAddAccountModal() {
        document.getElementById("addAccountModal").style.display = "block";
      }

      function closeAddAccountModal() {
        document.getElementById("addAccountModal").style.display = "none";
        document.getElementById("addAccountForm").reset();
      }

      // Adicionar conta
      document
        .getElementById("addAccountForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData.entries());
          data.is_master = data.is_master === "true";

          try {
            const response = await fetch(`${API_BASE}/accounts`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            const result = await response.json();

            if (result.success) {
              showAlert("Conta adicionada com sucesso!", "success");
              closeAddAccountModal();
              refreshStatus();
            } else {
              showAlert("Erro ao adicionar conta: " + result.error, "error");
            }
          } catch (error) {
            showAlert("Erro de conex√£o: " + error.message, "error");
          }
        });

      // Limpar todas as contas
      async function clearAllAccounts() {
        // Confirmar a√ß√£o
        if (
          !confirm(
            "‚ö†Ô∏è ATEN√á√ÉO: Esta a√ß√£o ir√° remover TODAS as contas do banco de dados.\n\nEsta a√ß√£o √© IRREVERS√çVEL!\n\nTem certeza que deseja continuar?"
          )
        ) {
          return;
        }

        // Segunda confirma√ß√£o
        if (
          !confirm(
            'üö® √öLTIMA CONFIRMA√á√ÉO: Todas as contas ser√£o DELETADAS permanentemente.\n\nDigite "CONFIRMAR" se realmente deseja prosseguir:'
          )
        ) {
          return;
        }

        try {
          const response = await fetch(`${API_BASE}/accounts/clear`, {
            method: "DELETE",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();

          if (result.success) {
            showAlert(
              `‚úÖ ${result.accounts_removed} contas removidas com sucesso!`,
              "success"
            );
            refreshStatus();
            loadLogs();
          } else {
            showAlert("‚ùå Erro ao limpar contas: " + result.error, "error");
          }
        } catch (error) {
          showAlert("‚ùå Erro de conex√£o: " + error.message, "error");
        }
      }

      // Testar configura√ß√µes do sistema
      async function testConfig() {
        try {
          showAlert("üîç Testando configura√ß√µes...", "info");

          const response = await fetch(`${API_BASE}/config/test`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();

          if (result.success) {
            const config = result.config;
            let message = "üìã **Status das Configura√ß√µes:**\n\n";

            message += `‚Ä¢ Contas cadastradas: ${config.accounts_count}\n`;
            message += `‚Ä¢ Contas master: ${config.master_accounts}\n`;

            if (config.sample_subdomain) {
              message += `‚Ä¢ Exemplo de conta: ${config.sample_subdomain}\n`;
              message += `‚Ä¢ Refresh token: ${
                config.sample_has_refresh_token ? "‚úÖ Presente" : "‚ùå Ausente"
              }\n`;
            }

            message += "\n**Recomenda√ß√µes:**\n";
            const recommendations = result.recommendations.filter(
              (r) => r !== null
            );
            if (recommendations.length === 0) {
              message += "‚úÖ Todas as configura√ß√µes b√°sicas est√£o ok!";
            } else {
              recommendations.forEach((rec) => {
                message += `‚Ä¢ ${rec}\n`;
              });
            }

            // Usar alert para mostrar informa√ß√µes detalhadas
            alert(message);

            // Mostrar mensagem resumida
            if (recommendations.length === 0) {
              showAlert("‚úÖ Configura√ß√µes b√°sicas OK!", "success");
            } else {
              showAlert(
                `‚ö†Ô∏è ${recommendations.length} configura√ß√£o(√µes) pendente(s)`,
                "warning"
              );
            }
          } else {
            showAlert(
              "‚ùå Erro ao testar configura√ß√µes: " + result.error,
              "error"
            );
          }
        } catch (error) {
          showAlert("‚ùå Erro de conex√£o: " + error.message, "error");
        }
      }

      // Testar todas as contas cadastradas
      async function testAllAccounts() {
        try {
          showAlert("üß™ Testando todas as contas...", "info");

          const response = await fetch(`${API_BASE}/test/accounts`, {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          });

          const result = await response.json();

          if (result.success) {
            const results = result.results;
            let message = "üß™ **Teste de Todas as Contas:**\n\n";

            message += `üìä **Resumo:**\n`;
            message += `‚Ä¢ Total de contas: ${results.total_accounts}\n`;
            message += `‚Ä¢ Sucessos: ${results.successful_tests}\n`;
            message += `‚Ä¢ Falhas: ${results.failed_tests}\n\n`;

            message += `üìã **Detalhes por Conta:**\n`;

            results.details.forEach((account, index) => {
              const status = account.overall_status === "success" ? "‚úÖ" : "‚ùå";
              message += `\n${index + 1}. ${status} ${account.subdomain} ${
                account.is_master ? "(MASTER)" : "(ESCRAVA)"
              }\n`;

              Object.keys(account.tests).forEach((testName) => {
                const test = account.tests[testName];
                const testStatus = test.success ? "‚úÖ" : "‚ùå";
                message += `   ${testStatus} ${testName}`;

                if (test.count !== undefined) {
                  message += ` (${test.count} itens)`;
                }
                if (test.names && test.names.length > 0) {
                  message += `: ${test.names.join(", ")}`;
                }
                if (!test.success && test.error) {
                  message += ` - ERRO: ${test.error}`;
                }
                message += `\n`;
              });

              if (account.general_error) {
                message += `   ‚ùå Erro geral: ${account.general_error}\n`;
              }
            });

            // Mostrar detalhes completos
            alert(message);

            // Mostrar resumo
            if (results.failed_tests === 0) {
              showAlert(
                `‚úÖ Todas as ${results.total_accounts} contas passaram nos testes!`,
                "success"
              );
            } else {
              showAlert(
                `‚ö†Ô∏è ${results.successful_tests}/${results.total_accounts} contas OK`,
                "warning"
              );
            }
          } else {
            showAlert("‚ùå Erro ao testar contas: " + result.error, "error");
          }
        } catch (error) {
          showAlert("‚ùå Erro de conex√£o: " + error.message, "error");
        }
      }

      // Fechar modal ao clicar fora
      window.onclick = function (event) {
        const modal = document.getElementById("addAccountModal");
        if (event.target === modal) {
          closeAddAccountModal();
        }
      };

      // Auto-refresh dos logs a cada 30 segundos
      setInterval(loadLogs, 30000);
    </script>
  </body>
</html>
